<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>蒋カイセキ 的博客</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">蒋カイセキ 的博客</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">使用p6spy监控分析sql输出log日志</h2>
	<h5 id="">2016-04-12 21:08:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/shoukaiseki/blog/static/19285614920163129817280/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><p>java 驱动配置为</p><p>url="jdbc:p6spy:oracle:thin:@localhost:1521:orcl" 其中的p6spy必须要，因为这样才会被拦截</p><p>drive=com.p6spy.engine.spy.P6SpyDriver</p></div><div>jar及java代码和配置文件下载地址:&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://pan.baidu.com/s/1kVhHo6F"   >http://pan.baidu.com/s/1kVhHo6F</a></div><div>CustomizeLineFormat &nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://pan.baidu.com/s/1dFtbo8h"   >http://pan.baidu.com/s/1dFtbo8h</a></div><div>spy.properties 配置如下</div><div><pre class="prettyprint"   ><p>###<br># #%L<br># P6Spy<br># %%<br># Copyright (C) 2013 P6Spy<br># %%<br># Licensed under the Apache License, Version 2.0 (the "License");<br># you may not use this file except in compliance with the License.<br># You may obtain a copy of the License at<br># <br>#      http://www.apache.org/licenses/LICENSE-2.0<br># <br># Unless required by applicable law or agreed to in writing, software<br># distributed under the License is distributed on an "AS IS" BASIS,<br># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br># See the License for the specific language governing permissions and<br># limitations under the License.<br># #L%<br>###<br><br>#################################################################<br># P6Spy Options File                                            #<br># See documentation for detailed instructions                   #<br># http://p6spy.github.io/p6spy/2.0/configandusage.html          #<br>#################################################################<br><br>#################################################################<br># MODULES                                                       #<br>#                                                               #<br># Module list adapts the modular functionality of P6Spy.		#<br># Only modules listed are active.						        #<br># (default is com.p6spy.engine.logging.P6LogFactory and         #<br># com.p6spy.engine.spy.P6SpyFactory)                            #<br># Please note that the core module (P6SpyFactory) can't be		# <br># deactivated. 													#<br># Unlike the other properties, activation of the changes on     #<br># this one requires reload.										#<br>#################################################################<br>#modulelist=com.p6spy.engine.spy.P6SpyFactory,com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory<br>modulelist=com.p6spy.engine.spy.P6SpyFactory,com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory<br>################################################################<br># CORE (P6SPY) PROPERTIES                                      #<br>################################################################<br><br># A comma separated list of JDBC drivers to load and register.<br># (default is empty)<br>#<br># Note: This is normally only needed when using P6Spy in an<br># application server environment with a JNDI data source or when<br># using a JDBC driver that does not implement the JDBC 4.0 API<br># (specifically automatic registration).<br>#driverlist=<br>#url="jdbc:p6spy:oracle:thin:@localhost:1521:orcl" 其中的p6spy必须要，因为这样才会被拦截<br>#drive=com.p6spy.engine.spy.P6SpyDriver<br>driverlist=oracle.jdbc.driver.OracleDriver<br># for flushing per statement<br># (default is false)<br>#autoflush = false<br><br><br># prints a stack trace for every statement logged<br>#stacktrace=false<br># if stacktrace=true, specifies the stack trace to print<br>#stacktraceclass=<br><br># determines if property file should be reloaded<br># Please note: reload means forgetting all the previously set<br># settings (even those set during runtime - via JMX)<br># and starting with the clean table <br># (default is false)<br>#reloadproperties=false<br><br># determines how often should be reloaded in seconds<br># (default is 60)<br>#reloadpropertiesinterval=60<br><br># specifies the appender to use for logging<br># Please note: reload means forgetting all the previously set<br># settings (even those set during runtime - via JMX)<br># and starting with the clean table <br># (only the properties read from the configuration file)<br># (default is com.p6spy.engine.spy.appender.FileLogger)<br>#appender=com.p6spy.engine.spy.appender.Slf4JLogger<br>#appender=com.p6spy.engine.spy.appender.StdoutLogger<br><br>appender=com.p6spy.engine.spy.appender.FileLogger<br><br># name of logfile to use, note Windows users should make sure to use forward slashes in their pathname (e:/test/spy.log) <br># (used for com.p6spy.engine.spy.appender.FileLogger only)<br># (default is spy.log)<br>#logfile = spy.log<br>#windows 用户请用 C:/spy.log 格式，不要用\<br>logfile =/tmp/win/spy.log<br><br># append to the p6spy log file. if this is set to false the<br># log file is truncated every time. (file logger only)<br># (default is true)<br>＃追加到 p6spy 日志文件。如果设置为false<br>＃日志文件被截断每次。 （只限于文件记录器）<br>＃（默认为true）<br>#append=true<br><br># class to use for formatting log messages (default is: com.p6spy.engine.spy.appender.SingleLineFormat)<br>#多行输出为 com.p6spy.engine.spy.appender.MultiLineFormat<br>#行的时间格式化配置在 dateformat 设定<br>#current time|execution time|category|connection id|statement SQL String|effective SQL string<br>#日志格式为 当前时间戳|执行语句花费的时间|调用的类别|connectionId|声明SQL字符串|有效的SQL字符串<br>logMessageFormat=com.p6spy.engine.spy.appender.SingleLineFormat<br>#logMessageFormat=com.shoukaiseki.p6spy.CustomizeLineFormat<br><br># format that is used for logging of the date/time/... (has to be compatible with java.text.SimpleDateFormat)<br># (default is dd-MMM-yy)<br>databaseDialectDateFormat=yyyy-MM-dd HH:mm:ss<br><br># sets the date format using Java's SimpleDateFormat routine. <br># In case property is not set, miliseconds since 1.1.1970 (unix time) is used (default is empty)<br>#dateformat=<br>dateformat=yyyy-MM-dd HH:mm:ss<br><br># whether to expose options via JMX or not<br># (default is true)<br>#jmx=true<br><br># if exposing options via jmx (see option: jmx), what should be the prefix used?<br># jmx naming pattern constructed is: com.p6spy(.&lt;jmxPrefix&gt;)?:name=&lt;optionsClassName&gt;<br># please note, if there is already such a name in use it would be unregistered first (the last registered wins)<br># (default is none)<br>#jmxPrefix=<br><br>#################################################################<br># DataSource replacement                                        #<br>#                                                               #<br># Replace the real DataSource class in your application server  #<br># configuration with the name com.p6spy.engine.spy.P6DataSource #<br># (that provides also connection pooling and xa support).       #<br># then add the JNDI name and class name of the real             #<br># DataSource here                                               #<br>#                                                               #<br># Values set in this item cannot be reloaded using the          #<br># reloadproperties variable. Once it is loaded, it remains      #<br># in memory until the application is restarted.                 #<br>#                                                               #<br>#################################################################<br>#realdatasource=/RealMySqlDS<br>#realdatasourceclass=com.mysql.jdbc.jdbc2.optional.MysqlDataSource<br><br>#################################################################<br># DataSource properties                                         #<br>#                                                               #<br># If you are using the DataSource support to intercept calls    #<br># to a DataSource that requires properties for proper setup,    #<br># define those properties here. Use name value pairs, separate  #<br># the name and value with a semicolon, and separate the         #<br># pairs with commas.                                            #<br>#                                                               #<br># The example shown here is for mysql                           #<br>#                                                               #<br>#################################################################<br>#realdatasourceproperties=port;3306,serverName;myhost,databaseName;jbossdb,foo;bar<br><br>#################################################################<br># JNDI DataSource lookup                                        #<br>#                                                               #<br># If you are using the DataSource support outside of an app     #<br># server, you will probably need to define the JNDI Context     #<br># environment.                                                  #<br>#                                                               #<br># If the P6Spy code will be executing inside an app server then #<br># do not use these properties, and the DataSource lookup will   #<br># use the naming context defined by the app server.             #<br>#                                                               #<br># The two standard elements of the naming environment are       #<br># jndicontextfactory and jndicontextproviderurl. If you need    #<br># additional elements, use the jndicontextcustom property.      #<br># You can define multiple properties in jndicontextcustom,      #<br># in name value pairs. Separate the name and value with a       #<br># semicolon, and separate the pairs with commas.                #<br>#                                                               #<br># The example shown here is for a standalone program running on #<br># a machine that is also running JBoss, so the JDNI context     #<br># is configured for JBoss (3.0.4).                              #<br>#                                                               #<br># (by default all these are empty)                              #<br>#################################################################<br>#jndicontextfactory=org.jnp.interfaces.NamingContextFactory<br>#jndicontextproviderurl=localhost:1099<br>#jndicontextcustom=java.naming.factory.url.pkgs;org.jboss.nameing:org.jnp.interfaces<br><br>#jndicontextfactory=com.ibm.websphere.naming.WsnInitialContextFactory<br>#jndicontextproviderurl=iiop://localhost:900<br><br>################################################################<br># P6 LOGGING SPECIFIC PROPERTIES                               #<br>################################################################<br><br># filter what is logged<br># please note this is a precondition for usage of: include/exclude/sqlexpression<br># (default is false)<br>#filter=false<br><br># comma separated list of strings to include<br># please note that special characters escaping (used in java) has to be done for the provided regular expression<br># (default is empty)<br>#include =<br># comma separated list of strings to exclude<br># (default is empty)<br>#exclude =<br><br># sql expression to evaluate if using regex<br># please note that special characters escaping (used in java) has to be done for the provided regular expression<br># (default is empty)<br>#sqlexpression = <br><br>#list of categories to exclude: error, info, batch, debug, statement,<br>#commit, rollback and result are valid values<br># (default is info,debug,result,resultset,batch)<br>#excludecategories=info,debug,result,resultset,batch<br><br># Execution threshold applies to the standard logging of P6Spy.       <br># While the standard logging logs out every statement          <br># regardless of its execution time, this feature puts a time   <br># condition on that logging. Only statements that have taken   <br># longer than the time specified (in milliseconds) will be     <br># logged. This way it is possible to see only statements that  <br># have exceeded some high water mark.                          <br># This time is reloadable.                                     <br>#<br># executionThreshold=integer time (milliseconds)<br># (default is 0)<br>#executionThreshold=<br><br>################################################################<br># P6 OUTAGE SPECIFIC PROPERTIES                                #<br>################################################################<br># Outage Detection<br>#<br># This feature detects long-running statements that may be indicative of<br># a database outage problem. If this feature is turned on, it will log any<br># statement that surpasses the configurable time boundary during its execution.<br># When this feature is enabled, no other statements are logged except the long<br># running statements. The interval property is the boundary time set in seconds.<br># For example, if this is set to 2, then any statement requiring at least 2<br># seconds will be logged. Note that the same statement will continue to be logged<br># for as long as it executes. So if the interval is set to 2, and the query takes<br># 11 seconds, it will be logged 5 times (at the 2, 4, 6, 8, 10 second intervals).<br>#<br># outagedetection=true|false<br># outagedetectioninterval=integer time (seconds)<br>#<br># (default is false)<br>#outagedetection=false<br># (default is 60)<br>#outagedetectioninterval=30</p></pre><br></div><div>java实例代码</div><div><pre class="prettyprint"   ><p><br>	import java.sql.Connection;<br>	import java.sql.DriverManager;<br>	import java.sql.ResultSet;<br>	import java.sql.ResultSetMetaData;<br>	import java.sql.SQLException;<br>	import java.sql.Statement;<br><br><br>public class Test {<br><br>		static Connection con = null;<br>		static Statement sm = null;<br>		static ResultSet rs = null;<br>		static String tableName = null;<br>		static String cName = null;<br>		static String result = null;<br>		static String url = "jdbc:p6spy:oracle:thin:@localhost:1521:eamprddb";<br>		// private String url = "jdbc:oracle:thin:@localhost:1521:orcl";<br>//		static String driver = "oracle.jdbc.driver.OracleDriver";<br>		static String driver = "com.p6spy.engine.spy.P6SpyDriver";<br>		static String user = "maximo";<br>		static String password = "maximo";<br><br>		public void setDefuorutoConnection() {<br>			try {<br>				// （1）装载并注册数据库的JDBC驱动程序<br>				// 载入JDBC驱动：oracle安装目录下的jdbc\lib\classes12.jar<br>				println("正在试图加载驱动程序 " + driver);<br>				println("驱动程序已加载");<br>				// 注册JDBC驱动：有些地方可不用此句<br>				println("url=" + url);<br>				println("user=" + user);<br>				println("password=" + password);<br>				println("正在试图连接数据库--------");<br><br>				con = DriverManager.getConnection(url, user, password);<br><br>				println("OK,成功连接到数据库");<br><br>				/**<br>				 * 关闭自动更新<br>				 */<br>				con.setAutoCommit(false);<br>			} catch (Exception ex) {<br>				ex.printStackTrace();<br>				println(ex.getMessage(), true);<br>			}<br>		}<br><br><br><br>		public static void main(String[] args) throws SQLException {<br>			Test jd = new Test();<br>			jd.setDefuorutoConnection();<br>			jd.readData();<br>			com.p6spy.engine.spy.appender.SingleLineFormat adsf;<br>		}<br><br>		public  void readData() {<br>			try {<br>				/*<br>				 * 查询数据<br>				 */<br>				Statement st = con.createStatement();<br>				st = con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY);<br>				ResultSet r = st<br>						.executeQuery("SELECT ROWNUM,UTL_INADDR.get_host_name() ,sysdate,user,dbms_random.random FROM dual" +<br>								" CONNECT BY LEVEL &lt;= 1");<br>				r.last();<br>				System.out.println("行数"+r.getRow());<br>				r.beforeFirst() ;//将光标移动到此 ResultSet 对象的开头，正好位于第一行之前。<br>				<br>				ResultSetMetaData rsmd=r.getMetaData();<br>				int column=rsmd.getColumnCount();<br>				System.out.println("列数为"+column);<br>				for (int i = 0; i &lt; rsmd.getColumnCount() ; i++) {<br>					System.out.print(rsmd.getColumnName(i+1)+"\t");<br>				}<br>				System.out.println();<br>				while (r.next()) {<br>					for (int i = 0; i &lt; column; i++) {<br>						System.out.print(r.getString(i+1)+"\t");<br>					}<br>					System.out.println();<br>				}<br><br>				r.close();<br>				st.close();<br>				con.close();<br>				System.out.println("查询结束!");<br>			} catch (Exception ex) {<br>				ex.printStackTrace();<br>			}<br>		}<br><br><br>		public static void println() {<br><br>		}<br><br>		public static void println(String s, boolean b) {<br>			System.out.println(s);<br>		}<br><br>		public static void println(String s) {<br>			System.out.println(s);<br>		}<br>	}<br><br><br></p></pre><br></div></div>
	</div>
</div>
</body>
</html>