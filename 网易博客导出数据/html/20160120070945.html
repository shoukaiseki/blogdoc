<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>蒋カイセキ 的博客</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">蒋カイセキ 的博客</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">java 调用so库文件</h2>
	<h5 id="">2016-01-20 7:09:45&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/shoukaiseki/blog/static/19285614920160207945488/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><br></div><div><div>本文参考自&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.cnblogs.com/yangxia-test/p/4065242.html"   >http://www.cnblogs.com/yangxia-test/p/4065242.html</a></div><div><br></div><div>//---1.首先创建java类--- //{{{1</div><div>mkdir -p /tmp/win/javaso/test</div><div>vim /tmp/win/javaso/test/Hello.java</div><div><br></div><div><pre class="prettyprint"   ><p>package test;<br>public class Hello<br>{<br>    static<br>    {<br>        System.loadLibrary("goodluck");<br>    }<br>    public native static int get();<br>    public native static void set(int i);<br>    public static void main(String[] args)<br>    {<br>        Hello hello = new Hello();<br>        System.out.println("before="+hello.get());<br>        hello.set(10);<br>        System.out.println("after="+hello.get());<br>    }<br>}</p></pre><br></div><div><br></div><div><br></div><div><br></div><div>//---2.编译java类 &nbsp;--- //{{{1</div><div>javac test/Hello.java</div><div><br></div><div><br></div><div>//---3.生成对应的.h头文件,本例中生成的头文件名为 test_Hello.h--- //{{{1</div><div><br></div><div>javah test.Hello</div><div><br></div><div><br></div><div>//---4.编写HelloJavaSO.c文件，实现引用第3步中生成的.h头文件，并实现其中声明的方法。--- //{{{1</div><div>vim /tmp/win/javaso/HelloJavaSO.c</div><div><pre class="prettyprint"   ><p>#include "test_Hello.h"<br>int i = 0;<br>JNIEXPORT jint JNICALL Java_test_Hello_get(JNIEnv *env, jclass jc)<br>{<br>    return i;<br>}<br>JNIEXPORT void JNICALL Java_test_Hello_set(JNIEnv *env, jclass jc, jint j)<br>{<br>    i = j;<br>}</p></pre><br></div><div><br></div><div>//---5.将第4步中编写的HelloJavaSO.c文件，编译成.o文件--- //{{{1</div><div><br></div><div>gcc -fPIC -D_REENTRANT -I/opt/java/ibm-java-x86-60/include -I/opt/java/ibm-java-x86-60/include/linux -c HelloJavaSO.c</div><div>gcc -fPIC -D_REENTRANT -I$JAVA_HOME/include -I$JAVA_HOME/include/linux -c HelloJavaSO.c</div><div><br></div><div>注: /opt/java/ibm-java-x86-60/include是jni.h头文件所在的路径</div><div>/opt/java/ibm-java-x86-60/include/linux 是jni_md.h或者jawt_md.h所在的路径</div><div>因为设置了JAVA_HOME，所以直接用 ￥JAVA_HOME代替</div><div><br></div><div>//---6.将第5步中生成的HelloJavaSO.o文件编译成.so库文件--- //{{{1</div><div>gcc -shared HelloJavaSO.o -o libgoodluck.so</div><div><br></div><div>注:和windows下不同，linux的库文件必须是以libxxx.so形式命令的(或者 libxxx.so.y，y是版本号)，lib前缀是为了系统能够识别它，xxx是java代码System.loadLibrary("xxx");中引用库的名字。</div><div><br></div><div>//---7.将第6步中生成的libgoodluck.so文件拷贝到java的加载库LD_LIBRARY_PATH指向的路径中。--- //{{{1</div><div>mkdir /tmp/win/javaso/lib</div><div>cp libgoodluck.so /tmp/win/javaso/lib/</div><div><br></div><div><br></div><div>//---8.测试执行--- //{{{1</div><div>java test.Hello&nbsp;</div><div><br></div><div>正常运行后的结果如下：</div><div>before=0</div><div>after=10</div><div><br></div><div>//---错误一--- //{{{2</div><div>如果出现此类情况，有两种方式可以处理</div><div>线程 "main" 中发生异常java.lang.UnsatisfiedLinkError: goodluck (Not found in java.library.path)</div><div><span style="white-space:pre;"   >	</span>at java.lang.ClassLoader.loadLibraryWithPath(ClassLoader.java:1007)</div><div><span style="white-space:pre;"   >	</span>at java.lang.ClassLoader.loadLibraryWithClassLoader(ClassLoader.java:971)</div><div><span style="white-space:pre;"   >	</span>at java.lang.System.loadLibrary(System.java:470)</div><div><span style="white-space:pre;"   >	</span>at test.Hello.&lt;clinit&gt;(Hello.java:6)</div><div><span style="white-space:pre;"   >	</span>at java.lang.J9VMInternals.initializeImpl(Native Method)</div><div><span style="white-space:pre;"   >	</span>at java.lang.J9VMInternals.initialize(J9VMInternals.java:200)</div><div>Could not find the main class: test.Hello. &nbsp;Program will exit.</div><div><br></div><div>//---第一种：设置 java.library.path 参数--- //{{{3</div><div>java -Djava.library.path=/tmp/win/javaso/lib/ test.Hello</div><div>//---第二种：设置 LD_LIBRARY_PATH 变量--- //{{{3</div><div>export LD_LIBRARY_PATH=/tmp/win/javaso/lib</div><div>java test.Hello</div><div><br></div><div>//---错误二--- //{{{2</div><div><br></div><div>加入出现以下情况，则因为gcc编译的为64位库文件，32位jdk无法识别，改用64位jdk即可</div><div>线程 "main" 中发生异常java.lang.UnsatisfiedLinkError: goodluck (/tmp/win/javaso/lib/libgoodluck.so: 错误 ELF 类: ELFCLASS64)</div><div><span style="white-space:pre;"   >	</span>at java.lang.ClassLoader.loadLibraryWithPath(ClassLoader.java:1007)</div><div><span style="white-space:pre;"   >	</span>at java.lang.ClassLoader.loadLibraryWithClassLoader(ClassLoader.java:971)</div><div><span style="white-space:pre;"   >	</span>at java.lang.System.loadLibrary(System.java:470)</div><div><span style="white-space:pre;"   >	</span>at test.Hello.&lt;clinit&gt;(Hello.java:6)</div><div><span style="white-space:pre;"   >	</span>at java.lang.J9VMInternals.initializeImpl(Native Method)</div><div><span style="white-space:pre;"   >	</span>at java.lang.J9VMInternals.initialize(J9VMInternals.java:200)</div><div>Could not find the main class: test.Hello. &nbsp;Program will exit.</div><div><br></div><div><br></div><div><br></div><div><br></div><div><div>//---x32,x64不同编译方式不同jdk测试--- //{{{2</div><div><br></div><div>经过gcc -m32 编译32位程序测试，64位jdk无法加载32位库文件</div><div>切换32位jdk之后执行编译</div><div><br></div><div>gcc -m32 -fPIC -D_REENTRANT -I$JAVA_HOME/include -I$JAVA_HOME/include/linux -c HelloJavaSO.c</div><div><br></div><div>gcc -m32 -shared HelloJavaSO.o -o libgoodluck.so</div><div><br></div><div>java -Djava.library.path=/tmp/win/javaso/ test.Hello</div><div>切换64位jdk之后运行 java -Djava.library.path=/tmp/win/javaso/ test.Hello 出错</div><div><br></div><div>64位jdk正确库文件编译方式</div><div>gcc -fPIC -D_REENTRANT -I$JAVA_HOME/include -I$JAVA_HOME/include/linux -c HelloJavaSO.c</div><div><br></div><div>gcc -shared HelloJavaSO.o -o libgoodluck.so</div><div><br></div><div>java -Djava.library.path=/tmp/win/javaso/ test.Hello</div><div><br></div><div>64位方式编译的在32位jdk同样无法运行</div></div><div><br></div><div><br></div><div><br></div><div><div>设置不同版本的的so</div><div>java -Djava.library.path=/tmp/win/javaso/libx32 test.Hello</div><div>java -Djava.library.path=/tmp/win/javaso/libx64 test.Hello</div></div><div><br></div><div>实例文件下载路径 &nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://pan.baidu.com/s/1pK3ire7"   >http://pan.baidu.com/s/1pK3ire7</a></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>