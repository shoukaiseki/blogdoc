<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>蒋カイセキ 的博客</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">蒋カイセキ 的博客</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">maximo工具栏工作流图标丢失</h2>
	<h5 id="">2015-12-18 18:47:34&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/shoukaiseki/blog/static/1928561492015111861756965/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前几天碰到个费解的问题,进入询价单时,点击保存发送工作流图标丢失<div>当时该问题只存在我同事本机的测试库和现在正式库中,而我在用的测试库却没有问题,这就纳闷了,然而我用我的测试库连同事的数据库,问题依旧,感觉代码不会有问题,应该是数据库内部某些配置出问题了</div><div><br></div><div>那就从头开查吧,先从jsp下手</div><div>toolbarbutton.jsp &nbsp;中输出信息,发现询价单应用中工具栏按钮都少了 发送工作流的按钮</div><div><pre class="prettyprint"   ><p>		String itemText = control.getProperty("text");<br>		String itemValue = control.getProperty("key");<br>		String itemPos = control.getProperty("position");<br>		String itemSubpos = control.getProperty("subposition");<br>		String itemActionKey = control.getProperty("accesskey");<br>		String type = control.getProperty("elementtype");<br>		String url = control.getProperty("url");<br>		String image = control.getProperty("image");<br>		String text = control.getProperty("text");<br>		String mxevent = control.getProperty("mxevent");<br>			System.out.print("key="+itemValue+",text="+itemText);<br>			System.out.print(",position="+itemPos+",subposition="+itemSubpos);<br>			System.out.print(",accesskey="+itemActionKey+",elementtype="+type);<br>			System.out.print(",url="+url+",image="+image);<br>			System.out.print(",text="+text+",mxevent="+mxevent);<br>			System.out.println();</p></pre><br></div><div><br><div><wbr></div><div>那就查了下图标是怎么来的,查找到了两个相关的类,最后代码中的两个类(psdi.webclient.controls.DynamicToolbar和psdi.workflow.virtual.WFToolBarSet) 查出了因为appname获取为空,则无法正常执行</div><div>既然是获取不到appname,那么我就在appbean中的SAVE()中测试了下</div><div><pre class="prettyprint"   ><p>com.shuto.mam.webclient.beans.rfq.FYRFQAppBean<br>  public int SAVE() throws MXException, RemoteException {	&nbsp;</p><p>          System.out.println("appname="+appName);//获取到的为空</p>	  System.out.println("appname="+app.getApp());//获取到正确的名称 RFQ<br><p>    return super.SAVE();<br>  }<br></p><div><br></div></pre>那么问题就简单了,找下appName是怎么赋值的就明白了,是在AppBean.initialize()方法中赋值的</div><div>找了下原来是在这里面获取了Mbo,没有判断空指针</div><div>我就无语了,2014年改动后应该就存在的问题,现在都快2016年了,才有人提起</div><div>最后回想了一下,我在我的测试库中因为设置了默认保存查询,所以进入应用时不会出现</div><div><pre class="prettyprint"   ><p>  protected void initialize()<br>    throws MXException, RemoteException<br>  {<br>		<br>    MboRemote thisMbo = getMbo();<br>    String status = thisMbo.getString("status");<br><br>		// 2014-03-26 新增只在填写报价单状态QBBECAUSE （签报说明）可填<br>    if (status.equals("填写报价单")) {<br>      thisMbo.setFieldFlag("QBBECAUSE", 7L, false);<br>      thisMbo.setFieldFlag("QBBECAUSE", 11L, true);<br>    } else {<br>      thisMbo.setFieldFlag("QBBECAUSE", 7L, true);<br>      thisMbo.setFieldFlag("QBBECAUSE", 11L, false);<br>    }<br>    super.initialize();<br>  }<br></p><div><br></div></pre><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><pre class="prettyprint"   ><p>psdi.webclient.controls.DynamicToolbar 类中方法</p><p><br>	private MboSetData getToolbarDefinitionFromNonpersistentSet()<br>	{<br>		try<br>		{<br>			String npMboName = getProperty("npmboname");<br><br>			if (!WebClientRuntime.isNull(npMboName))<br>			{<br>				<br>				String[] attributes = { keyAttribute, "toolbaricon", "description", "toolbarlocation", "toolbarsequence" };<br>				MboSetRemote mboSetRemote = null;<br><br>				MboRemote mboRemote = getPage().getAppInstance().getAppBean().getMbo();<br>				if (mboRemote != null)<br>				{<br>					mboSetRemote = mboRemote.getMboSet(npMboName);<br>				}<br><br>				if (mboSetRemote != null)<br>				{<br>					mboSetRemote.setQbeExactMatch(true);<br>					System.out.println("mboname="+mboRemote.getName());<br>//					System.out.println("keyAttribute="+keyAttribute);<br>					<br>					<br>					MboValueInfoStatic mboStatic = mboSetRemote.getMboValueInfoStatic(keyAttribute);<br>//					System.out.println("mboStatic="+mboStatic);<br>					if (mboStatic != null)<br>					{<br>						<br>						System.out.println("npMboName333="+npMboName);<br>						MboSetData mboSetData = mboSetRemote.getMboSetData(0, 50, attributes);<br>						//经测试,无工作流图标时未获取有效数据<br>						System.out.println("count="+mboSetRemote.count());<br>						<br>						for(MboData mbodata:mboSetData.getMboData()){<br>							for (String string : attributes) {<br>								MboValueData mvd = mbodata.getMboValueData(string);<br>//								System.out.print(string+"="+mvd.getData()+"\t");<br>							}<br>//							System.out.println();<br>						}<br>						mboSetData = mboSetRemote.getMboSetData(0, 50, attributes);<br>						return mboSetData;<br>					}<br><br><br>					System.out.println("Invalid keyattribute: '" + keyAttribute + "' specified in control:" + getId());<br>				}<br>			}<br>		}<br>		catch (Exception e) {}<br><br><br><br>		return null;<br>	}</p><p><br></p><p>psdi.workflow.virtual.WFToolBarSet 类中方法</p><p><br></p><p><br>   public MboRemote getMbo(int index)<br>     throws MXException, RemoteException<br>   {<br>     MXLogger log = ((WorkFlowServiceRemote)MXServer.getMXServer().lookup("WORKFLOW")).getWFLogger();<br>     log.debug("WFToolBarSet: getMbo(index =" + index + "), setBuilt = " + setBuilt);<br>     <br>     System.out.println("*********************WFToolBarSet.getMbo("+index+") setBuilt="+setBuilt);<br>     <br>     if (!setBuilt)<br>     {<br>       buildSet();<br>     }<br>     <br>     return super.getMbo(index);<br>   }<br>   <br> <br>   public void reset()<br>     throws MXException, RemoteException<br>   {<br>     MXLogger log = ((WorkFlowServiceRemote)MXServer.getMXServer().lookup("WORKFLOW")).getWFLogger();<br>     log.debug("WFToolBarSet: reset ");<br>     setBuilt = false;<br>     super.reset();<br>   }<br>   <br> <br> <br> <br>   private void buildSet()<br>     throws MXException, RemoteException<br>   {<br>     System.out.println("buildSet");<br>     setBuilt = true;<br>     MboRemote owner = getOwner();<br>     <br>     String app = owner.getThisMboSet().getApp();<br>     MXLogger log = ((WorkFlowServiceRemote)MXServer.getMXServer().lookup("WORKFLOW")).getWFLogger();<br>     log.debug("WFToolBarSet: app is " + app);<br>     <br> <br> <br>     System.out.println("buildSet1111");<br>     SqlFormat sqf = new SqlFormat(owner, "appname = :1");<br>     //经测试,无工作流图标时,输出app为空<br>     System.out.println("buildSet2222");<br>     System.out.println("app="+app);<br>     sqf.setObject(1, "WFAPPTOOLBAR", "APPNAME", app);<br>     System.out.println("buildSet2222aaa");<br>     MboSetRemote appButtons = owner.getMboSet("$APPBUTTONS", "WFAPPTOOLBAR", sqf.format());<br>     System.out.println("buildSet3333");<br>     appButtons.setOrderBy("TOOLBARSEQUENCE");<br>     <br>     System.out.println("sqf="+sqf.format());<br>     <br>//     if(true)<br>//    	 throw new MXApplicationException("", "asussss");<br> <br> <br>     ProfileRemote p = getMboServer().getProfile(getUserInfo());<br>     if (p.sysLevelApp(app))<br>     {<br>       if (p.getAppOptionAuth(app, "ROUTEWF", null)) {}<br> <br> <br> <br> <br>     }<br>     else if (p.siteLevelApp(app))<br>     {<br>       if (p.getAppOptionAuth(app, "ROUTEWF", owner.getString("siteid"))) {}<br> <br> <br> <br> <br>     }<br>     else if (!p.getAppOptionAuth(app, "ROUTEWF", owner.getString("orgid")))<br>     {<br>       return;<br>     }<br>     <br> <br>     MboSetEnumeration mse = new MboSetEnumeration(appButtons);<br>     while (mse.hasMoreElements())<br>     {<br>       log.debug("WFToolBarSet: adding a button");<br>       MboRemote appToolbarButton = mse.nextMbo();<br>       MboRemote toolbarButton = addAtEnd();<br>       toolbarButton.setValue("PROCESSNAME", appToolbarButton.getString("PROCESSNAME"), 2L);<br>       log.debug("WFToolBarSet: processname is " + appToolbarButton.getString("PROCESSNAME"));<br>       toolbarButton.setValue("TOOLBARLOCATION", appToolbarButton.getString("TOOLBARLOCATION"), 2L);<br>       log.debug("WFToolBarSet: toolbarlocation is " + appToolbarButton.getString("TOOLBARLOCATION"));<br>       <br>       toolbarButton.setValue("ICON", appToolbarButton.getString("TOOLBARICON"), 2L);<br>       toolbarButton.setValue("TOOLBARICON", appToolbarButton.getString("TOOLBARICON"), 2L);<br>       toolbarButton.setValue("ACTIVEICON", appToolbarButton.getString("TOOLBARICONACTIVE"), 2L);<br>       <br>       if (toolbarButton.isNull("PROCESSNAME"))<br>       {<br>         generalButton = toolbarButton;<br>       }<br>       else<br>       {<br>         processButtonMap.put(toolbarButton.getString("PROCESSNAME"), toolbarButton);<br>       }<br>       <br>       toolbarButton.setValue("TOOLBARSEQUENCE", appToolbarButton.getString("TOOLBARSEQUENCE"), 2L);<br>       log.debug("WFToolBarSet: sequence is " + appToolbarButton.getString("TOOLBARSEQUENCE"));<br>       toolbarButton.setValue("DESCRIPTION", appToolbarButton.getString("DESCRIPTION"), 2L);<br>       log.debug("WFToolBarSet: description is " + appToolbarButton.getString("DESCRIPTION"));<br>     }<br>     <br>     log.debug("WFToolBarSet: get active processes on current Mbo");<br>     <br>     SqlFormat sqfActive = null;<br>     <br>     sqfActive = new SqlFormat(owner, "active = :yes and ownertable = :1 and ownerid = :2");<br>     sqfActive.setObject(1, "WFINSTANCE", "OWNERTABLE", owner.getName());<br>     sqfActive.setLong(2, owner.getUniqueIDValue());<br>     MboSetRemote activeOnOwner = owner.getMboSet("$PROCESSACTIVE", "WFINSTANCE", sqfActive.format());<br>     MboSetEnumeration actives = new MboSetEnumeration(activeOnOwner);<br>     while (actives.hasMoreElements())<br>     {<br>       updateProcessStatus(actives.nextMbo().getString("PROCESSNAME"), true);<br>     }<br>     <br>     log.debug("WFToolBarSet: done building set");<br>     <br>     close();<br>   }<br>   <br> <br> </p><p><br></p></pre><br></div></div></div>
	</div>
</div>
</body>
</html>